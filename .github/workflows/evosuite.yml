name: EvoSuite Test Generation

on:
  workflow_dispatch:
    inputs:
      search_budget:
        description: "Tempo di ricerca per classe (secondi)"
        required: false
        default: "60"
      target_class:
        description: "Classe specifica da testare (vuoto = tutte)"
        required: false
        default: ""

jobs:
  evosuite:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          cache: maven

      - name: Download EvoSuite
        run: |
          set -euo pipefail
          mkdir -p tools/evosuite
          wget -q -O tools/evosuite/evosuite.jar \
            https://github.com/EvoSuite/evosuite/releases/download/v1.2.0/evosuite-1.2.0.jar

      - name: Build bookkeeper-server with EvoSuite profile
        run: |
          set -euo pipefail
          mvn clean install -DskipTests -Pevosuite -q \
            -Dmaven.javadoc.skip=true \
            -pl bookkeeper-server -am

      - name: Generate and filter classpath
        working-directory: bookkeeper-server
        run: |
          set -euo pipefail
          
          mvn dependency:build-classpath -Dmdep.outputFile=cp_raw.txt -Pevosuite -q
          
          echo "=== Filtering problematic JARs from classpath ==="
          tr ':' '\n' < cp_raw.txt | \
            grep -v "io_uring" | \
            grep -v "tcnative" | \
            grep -v "native-io" | \
            grep -v "transport-native-epoll" | \
            grep -v "circe-checksum" | \
            paste -sd: - > cp.txt
          
          # classpath finale (una sola riga) per EvoSuite
          echo "target/classes:$(cat cp.txt)" > cp_full.txt
          
          echo "=== Quick check: netty jars in cp_full ==="
          tr ':' '\n' < cp_full.txt | grep -E "netty-(buffer|common|transport)-" | head -20 || true
          
          # check (non-fatal) che netty-buffer contenga la classe incriminata
          NETTY_BUF="$(tr ':' '\n' < cp_full.txt | grep -m1 'netty-buffer-.*\.jar' || true)"
          if [ -n "$NETTY_BUF" ]; then
            if jar tf "$NETTY_BUF" | grep -q "io/netty/buffer/UnpooledUnsafeHeapByteBuf.class"; then
              echo "OK: UnpooledUnsafeHeapByteBuf trovata in $NETTY_BUF"
            else
              echo "::warning::netty-buffer trovato ma senza UnpooledUnsafeHeapByteBuf.class: $NETTY_BUF"
            fi
          else
            echo "::warning::netty-buffer NON presente nel classpath: rischio ClassNotFound"
          fi

      - name: Run EvoSuite
        working-directory: bookkeeper-server
        env:
          EVOSUITE_JAR: ${{ github.workspace }}/tools/evosuite/evosuite.jar
          JAVA_TOOL_OPTIONS: >-
            --add-opens=java.base/java.lang=ALL-UNNAMED
            --add-opens=java.base/java.util=ALL-UNNAMED
            --add-opens=java.base/java.io=ALL-UNNAMED
        run: |
          set -euo pipefail
          mkdir -p evosuite-tests evosuite-report
          
          CLASSES=(
            "org.apache.bookkeeper.client.BookKeeper"
            "org.apache.bookkeeper.bookie.storage.ldb.WriteCache"
          )
          
          if [ -n "${{ github.event.inputs.target_class }}" ]; then
            CLASSES=("${{ github.event.inputs.target_class }}")
          fi
          
          BUDGET="${{ github.event.inputs.search_budget }}"
          BUDGET="${BUDGET:-60}"
          
          for CLASS in "${CLASSES[@]}"; do
            echo "========================================"
            echo "Generating tests for: $CLASS"
            echo "Search budget: ${BUDGET}s"
            echo "========================================"
          
            # NOTA: usiamo CP_file_path (consigliato da EvoSuite) invece di -projectCP
            java -Xmx4g -jar "$EVOSUITE_JAR" \
              -class "$CLASS" \
              -DCP_file_path="cp_full.txt" \
              -Dtest_dir=evosuite-tests \
              -Dreport_dir=evosuite-report \
              -Dsandbox=false \
              -Dsearch_budget="$BUDGET" \
              -Dminimize=true \
              -Dassertion_strategy=all \
              -Djunit_check=false \
              -Dinstrument_libraries=false \
              2>&1 | tee "evosuite_${CLASS##*.}.log" \
              || echo "Warning: EvoSuite completed with issues for $CLASS"
          done
      

      - name: List generated tests
        if: always()
        working-directory: bookkeeper-server
        run: |
          echo "=== Generated test files ==="
          find evosuite-tests -name "*.java" -type f 2>/dev/null || echo "No tests generated"
          echo ""
          ls -laR evosuite-tests 2>/dev/null || true

      - name: Upload generated tests
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evosuite-tests
          path: bookkeeper-server/evosuite-tests/
          if-no-files-found: warn

      - name: Upload EvoSuite reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evosuite-reports
          path: |
            bookkeeper-server/evosuite-report/
            bookkeeper-server/evosuite_*.log
          if-no-files-found: ignore
