name: EvoSuite Test Generation

on:
  workflow_dispatch:
    inputs:
      search_budget:
        description: 'Tempo di ricerca per classe (secondi)'
        required: false
        default: '60'
      target_class:
        description: 'Classe specifica da testare (vuoto = tutte)'
        required: false
        default: ''

jobs:
  evosuite:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-evosuite-downgrade-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-evosuite-

      - name: Download EvoSuite
        run: |
          mkdir -p tools/evosuite
          wget -q -O tools/evosuite/evosuite.jar \
            https://github.com/EvoSuite/evosuite/releases/download/v1.2.0/evosuite-1.2.0.jar

      - name: Downgrade dependencies for EvoSuite compatibility
        run: |
          echo "=== Downgrading dependencies to Java 11 compatible versions ==="
          
          # Netty: 4.1.121.Final -> 4.1.86.Final (ultimo compilato con Java 11)
          sed -i 's/<netty.version>4.1.121.Final<\/netty.version>/<netty.version>4.1.86.Final<\/netty.version>/g' pom.xml
          
          # Netty io_uring (se presente)
          sed -i 's/<netty-iouring.version>0.0.26.Final<\/netty-iouring.version>/<netty-iouring.version>0.0.16.Final<\/netty-iouring.version>/g' pom.xml
          
          # Checker-qual (viene con Guava) - Guava 32 usa checker-qual 3.33 (Java 17+)
          # Downgrade Guava: 32.0.1-jre -> 31.1-jre
          sed -i 's/<guava.version>32.0.1-jre<\/guava.version>/<guava.version>31.1-jre<\/guava.version>/g' pom.xml
          
          # gRPC: versioni recenti potrebbero avere problemi
          sed -i 's/<grpc.version>1.72.0<\/grpc.version>/<grpc.version>1.53.0<\/grpc.version>/g' pom.xml
          
          # Protobuf
          sed -i 's/<protobuf.version>3.25.5<\/protobuf.version>/<protobuf.version>3.21.12<\/protobuf.version>/g' pom.xml
          
          echo "=== Dipendenze aggiornate ==="
          grep -E "(netty|guava|grpc|protobuf)\.version" pom.xml || true

      - name: Clean all old builds
        run: find . -name target -type d -exec rm -rf {} + 2>/dev/null || true

      - name: Build entire project with downgraded dependencies
        run: |
          mvn clean install -DskipTests -q \
            -Dmaven.compiler.source=11 \
            -Dmaven.compiler.target=11

      - name: Generate classpath for bookkeeper-server
        working-directory: bookkeeper-server
        run: |
          mvn dependency:build-classpath -Dmdep.outputFile=cp.txt -q

      - name: Verify classpath versions
        working-directory: bookkeeper-server
        run: |
          echo "=== Verifying dependency versions in classpath ==="
          echo "Netty version:"
          cat cp.txt | tr ':' '\n' | grep netty | head -3
          echo ""
          echo "Guava version:"
          cat cp.txt | tr ':' '\n' | grep guava | head -3
          echo ""
          echo "Checker-qual version:"
          cat cp.txt | tr ':' '\n' | grep checker | head -3

      - name: Run EvoSuite
        working-directory: bookkeeper-server
        run: |
          FULL_CP="target/classes:$(cat cp.txt)"
          mkdir -p evosuite-tests
          
          # Classi testate nel report (BookKeeper e WriteCache)
          CLASSES=(
            "org.apache.bookkeeper.client.BookKeeper"
            "org.apache.bookkeeper.bookie.storage.ldb.WriteCache"
          )
          
          # Se specificata una classe specifica, usa solo quella
          if [ -n "${{ github.event.inputs.target_class }}" ]; then
            CLASSES=("${{ github.event.inputs.target_class }}")
          fi
          
          BUDGET="${{ github.event.inputs.search_budget }}"
          BUDGET="${BUDGET:-60}"
          
          for CLASS in "${CLASSES[@]}"; do
            echo "========================================"
            echo "Generating tests for: $CLASS"
            echo "========================================"
            java -jar ../tools/evosuite/evosuite.jar \
              -class "$CLASS" \
              -projectCP "$FULL_CP" \
              -Dtest_dir=evosuite-tests \
              -Dreport_dir=evosuite-report \
              -Dsandbox=false \
              -Dsearch_budget=$BUDGET \
              -Dminimize=true \
              -Dassertion_strategy=all \
              -Djunit_check=false \
              || echo "Warning: EvoSuite failed for $CLASS, continuing..."
          done

      - name: List generated tests
        working-directory: bookkeeper-server
        run: |
          echo "=== Generated test files ==="
          find evosuite-tests -name "*.java" -type f 2>/dev/null || echo "No tests generated"
          echo ""
          ls -laR evosuite-tests 2>/dev/null || echo "evosuite-tests directory empty or not found"

      - name: Upload generated tests
        uses: actions/upload-artifact@v4
        with:
          name: evosuite-tests
          path: bookkeeper-server/evosuite-tests/
          if-no-files-found: warn

      - name: Upload EvoSuite reports
        uses: actions/upload-artifact@v4
        with:
          name: evosuite-reports
          path: bookkeeper-server/evosuite-report/
          if-no-files-found: ignore
